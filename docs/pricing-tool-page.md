# 测价工具页面设计

## 背景与目标
- 为业务运营人员提供自助测算运费的工具，避免手工计算或依赖客服。
- 输入完整的货运信息，结合百度地图提供的距离数据以及后台配置的测价规则，快速得出参考报价。
- 保证计算流程透明、输入校验严格、与“工具测价规则管理”模块保持一致的数据结构。

## 用户流程概述
1. 用户打开“测价工具”页面，默认展示空表单。
2. 用户通过地图选点分别选择发货地、卸货地，表单自动填充地名、详细地址、经纬度。
3. 用户录入货物尺寸（长、宽、高）、重量、包装信息等。
4. 页面在两个地址均确定后触发百度地图驾车路线规划，得到距离（公里）。
5. 前端根据长 * 宽 * 高计算体积（立方米），并与重量、距离一起构成测价请求参数。
6. 调用后端测价接口（使用工具测价规则管理中配置的规则）获取报价结果，展示给用户。
7. 用户可调整任意字段后重新测价，结果实时刷新。

## 页面结构建议
- **信息提示区**：展示测价使用说明、数据更新时间、注意事项。
- **表单区域**：按“线路信息”“货物信息”“包装信息”三段分组。
- **结果区域**：显示测算出的价格、使用规则名称、主要计算因子（距离/重量/体积），并提供再次测价按钮。
- **错误与状态提示**：表单级错误、接口失败提醒、加载中状态（遮罩或按钮 loading）。

## 表单字段定义
| 字段 | 控件类型 | 说明 | 校验 | 其它要求 |
| ---- | -------- | ---- | ---- | -------- |
| 发货地名称 | 输入框（只读） | 地点展示名称 | 必填（来源于地图选点） | 支持点击“重新选点”打开地图弹窗 |
| 发货地地址 | 文本（只读） | 详细地址 | 必填 | 与地图返回的 `address` 字段一致 |
| 发货地经度 | 隐藏 | 经纬度数据 | 必填，数值型 | 精度至少保留 6 位小数 |
| 发货地纬度 | 隐藏 | 经纬度数据 | 必填，数值型 | 精度至少保留 6 位小数 |
| 卸货地名称 | 输入框（只读） | 地点展示名称 | 必填 | 同发货地 |
| 卸货地地址 | 文本（只读） | 详细地址 | 必填 | 同发货地 |
| 卸货地经纬度 | 隐藏 | 经纬度数据 | 必填 | 纬度/经度同上 |
| 货物长度 (cm) | 数字输入 | 单件货物长度 | 必填，>0 | 可设置最小值 1，最大值由业务限制 |
| 货物宽度 (cm) | 数字输入 | 单件货物宽度 | 必填，>0 | - |
| 货物高度 (cm) | 数字输入 | 单件货物高度 | 必填，>0 | - |
| 货物重量 (kg) | 数字输入 | 单件货物重量 | 必填，>0 | 支持小数，最多三位小数 |
| 包装类型 | 下拉选择 | 纸箱/木箱/托盘/自定义等 | 必填 | 数据来源于后台字典接口 |
| 包装备注 | 文本域 | 备注信息 | 选填，<=200 字符 | 当选择自定义包装时必填 |
| 件数 | 数字输入 | 同规格件数 | 选填，默认为 1 | 影响总体积与重量，可选需求 |

> 体积计算公式：`volume = length * width * height * count / 1_000_000 (立方米)`，长度单位需先统一为厘米。

## 百度地图 API 集成
- **JS SDK 版本**：建议使用百度地图 WebGL JS API v1.0+，通过动态脚本加载。
- **地点选取**：
  - 使用 `BMapGL.Autocomplete` + `BMapGL.LocalSearch` 组合提供搜索与预选。
  - 周边拖拽选点场景，可结合 `BMapGL.Marker`，点击地图更新表单。
  - 返回值中解析 `point.lng`, `point.lat`, `addressComponents`。
- **驾车路线规划**：
  - 通过 `BMapGL.Driving` 或 Web Service API `/directionlite/v1/driving` 获取距离。
  - 关键参数：`origin=lat,lng`、`destination=lat,lng`，城市参数可选。
  - 读取 `distance`（单位米）字段，换算为公里（保留两位小数）。
- **失败重试策略**：若路线规划失败，给出重试按钮并提示用户检查位置精度。

## 数据计算与接口约定
1. **距离换算**：`distanceKm = round(distanceMeter / 1000, 2)`。
2. **体积换算**：`volume = length * width * height / 1_000_000`；若存在件数，乘以件数。
3. **重量**：表单原值（若按件数，需累加 `weight * count`）。
4. **价格接口**：
   - URL：`POST /api/pricing/rates/calc`
   - 请求参数示例：
```json
{
  "distance": 320.5,
  "volume": 1.25,
  "weight": 260,
  "packageType": "wood_crate",
  "extra": {
    "originName": "上海市徐汇区漕河泾",
    "originLng": 121.424203,
    "originLat": 31.195014,
    "destinationName": "杭州市滨江区联庄",
    "destinationLng": 120.20979,
    "destinationLat": 30.2084,
    "routeDistanceMeter": 320456
  }
}
```
   - 响应体：
```json
{
  "appliedRates": {
    "distanceRate": 2.5,
    "volumeRate": 180,
    "weightRate": 5
  },
  "breakdown": {
    "distance": 801.25,
    "volume": 225,
    "weight": 1300
  },
  "total": 2326.25,
  "rule": "东部干线标准计价"
}
```
   - 与“工具测价规则管理”保持一致：`rule` 字段返回命中的配置名称，`appliedRates` 为当前使用的费率档位。

## 状态与交互设计
- **提交前校验**：所有必填项通过前再允许调用测价接口，校验错误高亮具体字段。
- **计算按钮**：
  - 初始禁用，直到发货/卸货坐标与尺寸重量全部有效。
  - 点击后进入加载状态，防止重复提交。
- **结果展示**：
  - 突出总价，显示单位（元）。
  - 展示主要因子（距离、体积、重量）与费率拆解，便于用户理解。
  - 支持将结果复制或导出为图片/文本（可选需求）。
- **异常处理**：地图获取失败、接口报错、参数返回 NaN 时给出明确提示，并允许用户重试。

## 技术实现要点（前端）
- 页面组件：`src/views/business/getPrice/getPrice.vue` 负责渲染 UI，拆分为表单组件与结果组件。
- 地图组件：可封装为 `MapPicker` 子组件，提供 `@confirm` 事件返回地点信息。
- 状态管理：局部 `composition API` 状态即可；若后续复用，可抽象到 `pinia` store。
- API 模块：复用 `@/api/pricing` 中的请求封装，新增 `calcPrice` 方法。
- 测试：
  - 单元测试验证体积/重量换算逻辑。
  - E2E 测试（可选）覆盖完整提交流程与地图结果 mock。

## 边界场景与兼容性
- 发货地与卸货地相同：距离为 0 时仍允许提交，但需提示“同城短途”。
- 百度接口日调用量限制，需在页面内捕获 `status` 码进行友好提示。
- 输入超出后台支持范围（如体积过大）时，后台可能返回错误；前端应展示后端 message。
- 移动端适配：若页面需要 H5 支持，地图选点要考虑触摸交互与弹窗全屏。

## 依赖与待办
- 申请百度地图开放平台 AK，并在 `.env` 中配置 `VUE_APP_BAIDU_AK`。
- 确认后台价格接口参数与返回格式，如需扩展字段（如保险、加急服务），提前对齐。
- 与“工具测价规则管理”对接：确定测价公式中是否需要额外变量（如货物类别、时间窗口）。
- 设计稿需求：获取 UI/UX 设计确认布局、色板、交互细节。

